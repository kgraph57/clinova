name: Medical AI News Fetch (Weekly)

on:
  # æ¯é€±æœˆæ›œ 9:00 JST (æ—¥æ›œ 24:00 UTC)
  schedule:
    - cron: "0 0 * * 1"
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Fetch medical news data
        run: npx tsx scripts/fetch-medical-news.ts

      - name: Check for new data
        id: check
        run: |
          if git diff --quiet scripts/data/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            PAPERS=$(jq '.stats.totalPapers' scripts/data/latest-fetch.json)
            REGULATORY=$(jq '.stats.totalRegulatory' scripts/data/latest-fetch.json)
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "papers=$PAPERS" >> $GITHUB_OUTPUT
            echo "regulatory=$REGULATORY" >> $GITHUB_OUTPUT
          fi

      - name: Commit data
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add scripts/data/
          git commit -m "data: åŒ»ç™‚AIæœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾— ($(date +%Y-%m-%d))"
          git push

      - name: Create notification issue
        if: steps.check.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const papers = ${{ steps.check.outputs.papers || 0 }};
            const regulatory = ${{ steps.check.outputs.regulatory || 0 }};
            const date = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“° åŒ»ç™‚AIæœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº† (${date})`,
              body: `## è‡ªå‹•å–å¾—ãƒ‡ãƒ¼ã‚¿\n\n` +
                `- è«–æ–‡: **${papers}** ä»¶\n` +
                `- è¦åˆ¶ãƒ‹ãƒ¥ãƒ¼ã‚¹: **${regulatory}** ä»¶\n\n` +
                `### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—\n\n` +
                `Claude Code ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ:\n` +
                `\`\`\`\n` +
                `æœ€æ–°ã®å–å¾—ãƒ‡ãƒ¼ã‚¿ (scripts/data/latest-fetch.json) ã‹ã‚‰è¨˜äº‹ã‚’æ›¸ã„ã¦\n` +
                `\`\`\`\n\n` +
                `ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«: \`scripts/data/latest-fetch.json\``,
              labels: ['auto-generated', 'content']
            });
